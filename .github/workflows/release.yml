name: Release Mod

on:
  push:
    branches:
      - '**'

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Grant execution permission for gradlew
        run: chmod +x ./gradlew

      - name: Extract version from gradle.properties
        id: extract_version
        run: |
          version=$(grep '^mod_version=' gradle.properties | cut -d'=' -f2)
          echo "mod_version=$version" >> $GITHUB_OUTPUT

      - name: Build JAR with custom name
        run: |
          branch=${GITHUB_REF#refs/heads/}
          version=${{ steps.extract_version.outputs.mod_version }}
          jarName="TheStarryMiningListRebuilt-${version}-${branch}.jar"
          echo "Using JAR name: $jarName"

          ./gradlew clean build

          originalJar=$(ls build/libs/*.jar | head -n1)
          targetPath="build/libs/$jarName"

          if [[ "$originalJar" != "$targetPath" ]]; then
            mv "$originalJar" "$targetPath"
            echo "Renamed jar to $targetPath"
          else
            echo "Original jar already matches target, skipping rename."
          fi

      - name: Upload JAR as workflow artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: mod-jar-${{ steps.extract_version.outputs.mod_version }}-${{ github.ref_name }}
          path: build/libs/TheStarryMiningListRebuilt-${{ steps.extract_version.outputs.mod_version }}-${{ github.ref_name }}.jar

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ steps.extract_version.outputs.mod_version }}"
          release_name: "Release ${{ steps.extract_version.outputs.mod_version }} (branch ${{ github.ref_name }})"
          body: |
            Automated release from branch `${{ github.ref_name }}` with version `${{ steps.extract_version.outputs.mod_version }}`
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload JAR to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ steps.extract_version.outputs.mod_version }}"
          files: |
            build/libs/TheStarryMiningListRebuilt-${{ steps.extract_version.outputs.mod_version }}-${{ github.ref_name }}.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
